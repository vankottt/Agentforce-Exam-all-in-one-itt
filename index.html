<!DOCTYPE html>
<html lang="bg">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#007bff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="AF Exam">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23007bff'/><text x='50' y='65' text-anchor='middle' font-size='50'>üìù</text></svg>">
  <title>Agentforce Exam</title>
  <style>
    :root {
      --bg: #fff;
      --bg2: #fafafa;
      --bg3: #f0f0f0;
      --text: #333;
      --text2: #666;
      --border: #e0e0e0;
      --accent: #007bff;
      --success: #28a745;
      --danger: #dc3545
    }

    .dark {
      --bg: #1a1a2e;
      --bg2: #16213e;
      --bg3: #0f3460;
      --text: #eee;
      --text2: #aaa;
      --border: #0f3460;
      --accent: #4dabf7;
      --success: #51cf66;
      --danger: #ff6b6b
    }

    * {
      box-sizing: border-box
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 12px;
      font-size: 16px;
      line-height: 1.5;
      background: var(--bg);
      color: var(--text);
      transition: background .3s, color .3s
    }

    h2 {
      font-size: 1.4rem;
      margin: 0 0 12px;
      display: flex;
      justify-content: space-between;
      align-items: center
    }

    button {
      padding: 12px 16px;
      font-size: 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg2);
      color: var(--text);
      cursor: pointer;
      touch-action: manipulation
    }

    button:active {
      opacity: .8
    }

    button:disabled {
      opacity: .5;
      cursor: not-allowed
    }

    .hidden {
      display: none
    }

    #darkModeBtn {
      padding: 8px 12px;
      font-size: 14px
    }

    #setupPanel {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      background: var(--bg2)
    }

    .setup-step {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border)
    }

    .setup-step:last-child {
      margin-bottom: 0;
      border-bottom: none;
      padding-bottom: 0
    }

    .step-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap
    }

    .step-number {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--bg3);
      color: var(--text2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px
    }

    .step-number.done {
      background: var(--success);
      color: #fff
    }

    .step-number.active {
      background: var(--accent);
      color: #fff
    }

    .step-title {
      font-weight: 600;
      font-size: 15px
    }

    .mode-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap
    }

    .mode-buttons button {
      flex: 1;
      min-width: 140px;
      padding: 14px 16px
    }

    .mode-buttons button.selected {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent)
    }

    .mode-desc {
      font-size: 13px;
      color: var(--text2);
      margin-top: 8px
    }

    #examButtons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px
    }

    #examButtons button {
      flex: 1;
      min-width: calc(50% - 4px)
    }

    #startBtn {
      width: 100%;
      padding: 16px;
      font-size: 18px;
      font-weight: 600;
      background: var(--success);
      color: #fff;
      border-color: var(--success)
    }

    #statsPanel {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      background: var(--bg2);
      margin-bottom: 12px
    }

    #statsPanel h3 {
      margin: 0 0 12px;
      font-size: 16px;
      display: flex;
      justify-content: space-between
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px
    }

    .stat-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      text-align: center
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent)
    }

    .stat-label {
      font-size: 12px;
      color: var(--text2);
      margin-top: 4px
    }

    .weak-list {
      margin-top: 12px;
      padding: 10px;
      background: var(--bg);
      border-radius: 8px;
      font-size: 14px
    }

    .weak-list summary {
      cursor: pointer;
      font-weight: 600
    }

    .weak-item {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid var(--border)
    }

    .weak-item:last-child {
      border-bottom: none
    }

    #historyChart {
      width: 100%;
      height: 120px;
      margin-top: 12px
    }

    #examHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px
    }

    #timer {
      color: var(--text);
      font-size: 15px;
      font-weight: 600;
      padding: 8px 12px;
      background: var(--bg3);
      border-radius: 6px
    }

    #helpToggle {
      color: var(--text2);
      font-size: 14px;
      cursor: pointer
    }

    #helpBox {
      border: 1px solid var(--border);
      padding: 12px;
      font-size: 14px;
      color: var(--text2);
      margin-bottom: 12px;
      background: var(--bg2);
      border-radius: 8px
    }

    #progressBar {
      width: 100%;
      height: 8px;
      background: var(--bg3);
      border-radius: 4px;
      margin-bottom: 12px;
      overflow: hidden
    }

    #progressFill {
      height: 100%;
      background: var(--accent);
      transition: width .3s;
      width: 0
    }

    .question-header {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 12px
    }

    #counter {
      font-weight: 600;
      font-size: 15px;
      margin: 0
    }

    #questionTime {
      font-size: 13px;
      color: var(--text2)
    }

    #modeIndicator {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      display: inline-block;
      margin-top: 4px
    }

    #modeIndicator.learning {
      background: #d4edda;
      color: #155724
    }

    #modeIndicator.exam {
      background: #fff3cd;
      color: #856404
    }

    .dark #modeIndicator.learning {
      background: #1e5631;
      color: #a3e4b7
    }

    .dark #modeIndicator.exam {
      background: #5c4813;
      color: #ffeeba
    }

    .confidence-panel {
      border: 1px solid var(--border);
      background: var(--bg2);
      padding: 12px;
      font-size: 15px;
      border-radius: 8px;
      display: flex;
      gap: 20px;
      flex-wrap: wrap
    }

    .confidence-panel label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer
    }

    .confidence-panel input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer
    }

    .question-box {
      border: 1px solid var(--border);
      background: var(--bg2);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 12px
    }

    .question-box p {
      margin: 0;
      font-size: 16px;
      line-height: 1.6
    }

    .answers-box {
      border: 1px solid var(--border);
      background: var(--bg2);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px
    }

    .answer {
      padding: 14px 12px;
      margin-bottom: 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: flex-start;
      gap: 10px
    }

    .answer:last-child {
      margin-bottom: 0
    }

    .answer span {
      color: var(--text2);
      font-size: 13px;
      font-weight: 600;
      min-width: 24px
    }

    .answer label {
      flex: 1;
      font-size: 15px;
      line-height: 1.5;
      cursor: pointer;
      display: flex;
      align-items: flex-start;
      gap: 10px
    }

    .answer input[type="radio"] {
      width: 22px;
      height: 22px;
      min-width: 22px;
      cursor: pointer;
      margin: 0
    }

    .answer.correct {
      background: #d4edda;
      border-color: var(--success)
    }

    .answer.correct label {
      color: #155724;
      font-weight: 600
    }

    .answer.wrong {
      background: #f8d7da;
      border-color: var(--danger)
    }

    .answer.wrong label {
      color: #721c24;
      font-weight: 600
    }

    .dark .answer.correct {
      background: #1e5631
    }

    .dark .answer.correct label {
      color: #a3e4b7
    }

    .dark .answer.wrong {
      background: #5c1a1a
    }

    .dark .answer.wrong label {
      color: #f5a5a5
    }

    #resultLine {
      margin-top: 12px;
      padding: 12px;
      font-weight: 600;
      font-size: 15px;
      border-radius: 6px;
      text-align: center
    }

    #resultLine:empty {
      display: none
    }

    .nav-buttons {
      display: flex;
      gap: 10px;
      margin-top: 12px
    }

    .nav-buttons button {
      flex: 1;
      padding: 14px;
      font-size: 16px;
      font-weight: 600
    }

    #nextBtn {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent)
    }

    #resultsPanel {
      padding: 16px;
      background: var(--bg2);
      border-radius: 10px;
      margin-top: 12px;
      border: 1px solid var(--border)
    }

    #resultsPanel h3 {
      margin: 0 0 12px;
      font-size: 1.2rem
    }

    #resultsPanel p {
      margin: 8px 0;
      font-size: 15px;
      line-height: 1.5;
      word-break: break-word
    }

    #reviewButtons {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 16px
    }

    #reviewButtons button {
      width: 100%;
      text-align: left;
      padding: 14px 16px
    }

    @media(min-width:600px) {
      body {
        padding: 20px
      }

      .question-header {
        flex-direction: row;
        justify-content: space-between;
        align-items: center
      }

      #reviewButtons {
        flex-direction: row;
        flex-wrap: wrap
      }

      #reviewButtons button {
        width: auto;
        flex: 1
      }
    }
  </style>
</head>

<body>
  <h2>Agentforce Exam <button id="darkModeBtn">üåô</button></h2>

  <div id="statsPanel" class="hidden">
    <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ <button id="closeStatsBtn" style="padding:6px 10px;font-size:12px;">‚úï</button></h3>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="statTotalExams">0</div>
        <div class="stat-label">–ò–∑–ø–∏—Ç–∏</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statAvgScore">0%</div>
        <div class="stat-label">–°—Ä–µ–¥–µ–Ω —Ä–µ–∑—É–ª—Ç–∞—Ç</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statAvgTime">0s</div>
        <div class="stat-label">–°—Ä. –≤—Ä–µ–º–µ/–≤—ä–ø—Ä–æ—Å</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statPassRate">0%</div>
        <div class="stat-label">–í–∑–µ—Ç–∏ –∏–∑–ø–∏—Ç–∏</div>
      </div>
    </div>
    <canvas id="historyChart"></canvas>
    <details class="weak-list">
      <summary>üéØ –°–ª–∞–±–∏ —Ç–æ—á–∫–∏</summary>
      <div id="weakPointsList"></div>
    </details>
    <button id="clearStatsBtn" style="margin-top:12px;width:100%;background:var(--danger);color:#fff;">üóëÔ∏è –ò–∑—Ç—Ä–∏–π
      —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</button>
    <button id="resetAllBtn" style="margin-top:8px;width:100%;background:#888;color:#fff;">üîÑ –ù—É–ª–∏—Ä–∞–π –≤—Å–∏—á–∫–æ</button>
  </div>

  <div id="setupPanel">
    <div class="setup-step">
      <div class="step-header">
        <div class="step-number" id="step1num">1</div>
        <div class="step-title">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –≤—ä–ø—Ä–æ—Å–∏</div>
        <span id="loadStatus" style="margin-left:auto;">‚è≥ –ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</span>
      </div>
    </div>
    <div class="setup-step">
      <div class="step-header">
        <div class="step-number" id="step2num">2</div>
        <div class="step-title">–ò–∑–±–µ—Ä–∏ —Ä–µ–∂–∏–º</div>
      </div>
      <div class="mode-buttons">
        <button id="learningModeBtn" disabled>üìö Learning</button>
        <button id="examModeBtn" disabled>üìù Exam</button>
      </div>
      <div class="mode-desc" id="modeDesc">–ü—ä—Ä–≤–æ –∏–∑—á–∞–∫–∞–π –≤—ä–ø—Ä–æ—Å–∏—Ç–µ –¥–∞ —Å–µ –∑–∞—Ä–µ–¥—è—Ç.</div>
    </div>
    <div class="setup-step">
      <div class="step-header">
        <div class="step-number" id="step3num">3</div>
        <div class="step-title">–ò–∑–±–µ—Ä–∏ –∏–∑–ø–∏—Ç</div>
        <button id="reshuffleBtn" class="hidden" style="margin-left:auto;padding:8px 12px;font-size:14px;">üîÄ
          –†–∞–∑–±—ä—Ä–∫–∞–π</button>
      </div>
      <div id="examButtons"></div>
      <div id="examPlaceholder" style="color:var(--text2);font-size:14px;">–ü—ä—Ä–≤–æ –∏–∑–±–µ—Ä–∏ —Ä–µ–∂–∏–º.</div>
    </div>
    <div class="setup-step">
      <button id="statsBtn" style="width:100%;margin-bottom:10px;">üìä –í–∏–∂ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</button>
      <button id="startBtn" disabled>‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
    </div>
  </div>

  <div id="examUI" class="hidden">
    <div id="examHeader">
      <button id="exitBtn" style="padding:8px 12px;font-size:14px;">‚úï –ò–∑—Ö–æ–¥</button>
      <div id="timer">Time: 105:00</div>
      <span id="helpToggle">üõà –ü–æ–º–æ—â</span>
    </div>
    <div id="helpBox" class="hidden">
      <div>üî¢ <b>1‚Äì4</b> –∏–∑–±–æ—Ä | ‚û°Ô∏è <b>‚Üí/Enter</b> Next | ‚¨ÖÔ∏è <b>‚Üê</b> Back</div>
    </div>
    <div id="progressBar">
      <div id="progressFill"></div>
    </div>
    <div class="question-header">
      <div>
        <p id="counter"></p><span id="modeIndicator"></span>
        <div id="questionTime"></div>
      </div>
      <div class="confidence-panel">
        <label><input type="checkbox" id="dontKnow"> ‚ùì –ù–µ –∑–Ω–∞–º</label>
        <label><input type="checkbox" id="notSure"> ‚ö†Ô∏è –ù–µ —Å—ä–º —Å–∏–≥—É—Ä–µ–Ω</label>
      </div>
    </div>
    <div class="question-box">
      <p id="question"></p>
    </div>
    <div class="answers-box">
      <div id="answers"></div>
      <div id="resultLine"></div>
    </div>
    <div class="nav-buttons"><button id="backBtn">‚Üê Back</button><button id="nextBtn">Next ‚Üí</button></div>
  </div>

  <div id="resultsPanel" class="hidden"></div>

  <script>
    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./service-worker.js').catch(() => { }); }

    const $ = id => document.getElementById(id);

    // State
    let QUESTIONS = {}, ALL_QIDS = [], EXAMS = [], STACK = [], index = 0;
    let questionState = {}, answerOrder = {}, baseStack = null, baseState = null;
    let examStartTime = null, timerInterval = null, questionStartTime = null;
    const EXAM_TIME_SECONDS = 105 * 60;
    let currentRoundType = "base", currentMode = null, selectedExamIndex = null;

    // Persistent State
    let completedLearning = new Set(JSON.parse(localStorage.getItem('agentforce_completed_learning') || '[]'));
    let completedExam = new Set(JSON.parse(localStorage.getItem('agentforce_completed_exam') || '[]'));
    let history = JSON.parse(localStorage.getItem('agentforce_history') || '[]');
    let wrongCounts = JSON.parse(localStorage.getItem('agentforce_wrong') || '{}');

    // Dark Mode
    if (localStorage.getItem('darkMode') === 'true') { document.body.classList.add('dark'); $("darkModeBtn").textContent = '‚òÄÔ∏è'; }
    $("darkModeBtn").onclick = () => {
      document.body.classList.toggle('dark');
      const d = document.body.classList.contains('dark');
      $("darkModeBtn").textContent = d ? '‚òÄÔ∏è' : 'üåô';
      localStorage.setItem('darkMode', d);
    };

    // Load Questions
    fetch("./agentforce_questions.json")
      .then(r => { if (!r.ok) throw new Error(); return r.json(); })
      .then(d => {
        d.questions.forEach(q => { QUESTIONS[q.number] = q; ALL_QIDS.push(q.number); });
        $("loadStatus").textContent = `‚úÖ ${ALL_QIDS.length} –≤—ä–ø—Ä–æ—Å–∞`;
        $("loadStatus").style.color = "var(--success)";
        $("step1num").classList.add("done");
        $("step2num").classList.add("active");
        $("learningModeBtn").disabled = false;
        $("examModeBtn").disabled = false;
        $("modeDesc").textContent = "–ò–∑–±–µ—Ä–∏ –∫–∞–∫ –∏—Å–∫–∞—à –¥–∞ —Å–µ —É–ø—Ä–∞–∂–Ω—è–≤–∞—à.";
      })
      .catch(() => {
        $("loadStatus").textContent = "‚ùå –ì—Ä–µ—à–∫–∞";
        $("loadStatus").style.color = "var(--danger)";
      });

    // Helpers
    function shuffle(a) { return a.map(v => ({ v, r: Math.random() })).sort((a, b) => a.r - b.r).map(x => x.v); }
    function deepClone(o) { return JSON.parse(JSON.stringify(o)); }
    function getCorrectText(qid) { return QUESTIONS[qid].correct.map(a => QUESTIONS[qid].answers[a]).join(", "); }
    function ensureOrderForQid(qid) { if (!answerOrder[qid]) answerOrder[qid] = shuffle(Object.entries(QUESTIONS[qid].answers)); }

    function getCompletedExams() { return currentMode === "exam" ? completedExam : completedLearning; }
    function saveCompleted() {
      localStorage.setItem('agentforce_completed_learning', JSON.stringify([...completedLearning]));
      localStorage.setItem('agentforce_completed_exam', JSON.stringify([...completedExam]));
    }
    function loadCompleted() {
      completedLearning = new Set(JSON.parse(localStorage.getItem('agentforce_completed_learning') || '[]'));
      completedExam = new Set(JSON.parse(localStorage.getItem('agentforce_completed_exam') || '[]'));
    }
    function saveExams() { localStorage.setItem('agentforce_exams', JSON.stringify(EXAMS)); }
    function saveHistory() { localStorage.setItem('agentforce_history', JSON.stringify(history)); }
    function saveWrong() { localStorage.setItem('agentforce_wrong', JSON.stringify(wrongCounts)); }

    // Stats Panel
    $("statsBtn").onclick = () => { renderStatsPanel(); $("statsPanel").classList.remove('hidden'); };
    $("closeStatsBtn").onclick = () => $("statsPanel").classList.add('hidden');

    $("clearStatsBtn").onclick = () => {
      if (!confirm('–ò–∑—Ç—Ä–∏–π –∏—Å—Ç–æ—Ä–∏—è –∏ —Å–ª–∞–±–∏ —Ç–æ—á–∫–∏?')) return;
      history = []; wrongCounts = {};
      localStorage.removeItem('agentforce_history');
      localStorage.removeItem('agentforce_wrong');
      renderStatsPanel();
    };

    $("resetAllBtn").onclick = () => {
      if (!confirm('‚ö†Ô∏è –¢–æ–≤–∞ —â–µ –∏–∑—Ç—Ä–∏–µ –í–°–ò–ß–ö–û. –°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏?')) return;
      history = []; wrongCounts = {}; completedLearning.clear(); completedExam.clear(); EXAMS = [];
      localStorage.removeItem('agentforce_history');
      localStorage.removeItem('agentforce_wrong');
      localStorage.removeItem('agentforce_completed_learning');
      localStorage.removeItem('agentforce_completed_exam');
      localStorage.removeItem('agentforce_exams');
      $("statsPanel").classList.add('hidden');
      currentMode = null; selectedExamIndex = null;
      $("learningModeBtn").classList.remove("selected");
      $("examModeBtn").classList.remove("selected");
      $("step2num").classList.remove("done"); $("step2num").classList.add("active");
      $("step3num").classList.remove("done", "active");
      $("examButtons").innerHTML = "";
      $("examPlaceholder").style.display = "";
      $("reshuffleBtn").classList.add("hidden");
      $("startBtn").disabled = true;
      $("modeDesc").textContent = "–ò–∑–±–µ—Ä–∏ –∫–∞–∫ –∏—Å–∫–∞—à –¥–∞ —Å–µ —É–ø—Ä–∞–∂–Ω—è–≤–∞—à.";
    };

    function renderStatsPanel() {
      const t = history.length;
      const avgS = t ? Math.round(history.reduce((a, h) => a + h.pct, 0) / t) : 0;
      const avgT = t ? Math.round(history.reduce((a, h) => a + h.avgTime, 0) / t) : 0;
      const passed = history.filter(h => h.pct >= 72).length;
      const passR = t ? Math.round(passed / t * 100) : 0;
      $("statTotalExams").textContent = t;
      $("statAvgScore").textContent = avgS + '%';
      $("statAvgTime").textContent = avgT + 's';
      $("statPassRate").textContent = passR + '%';
      const sorted = Object.entries(wrongCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
      $("weakPointsList").innerHTML = sorted.length ? sorted.map(([q, c]) => `<div class="weak-item"><span>Q${q}</span><span>${c}x</span></div>`).join('') : '<div style="padding:8px;color:var(--text2);">–ù—è–º–∞ –¥–∞–Ω–Ω–∏</div>';
      drawChart();
    }

    function drawChart() {
      const canvas = $("historyChart"), ctx = canvas.getContext('2d');
      const w = canvas.width = canvas.offsetWidth, h = canvas.height = 120;
      ctx.clearRect(0, 0, w, h);
      const cs = getComputedStyle(document.body);
      if (history.length < 2) {
        ctx.fillStyle = cs.getPropertyValue('--text2');
        ctx.font = '14px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('–ù—É–∂–Ω–∏ —Å–∞ –ø–æ–Ω–µ 2 –∏–∑–ø–∏—Ç–∞', w / 2, h / 2);
        return;
      }
      const last10 = history.slice(-10), pad = 30, cW = w - pad * 2, cH = h - pad, stepX = cW / (last10.length - 1);
      ctx.strokeStyle = cs.getPropertyValue('--danger');
      ctx.setLineDash([5, 5]);
      ctx.beginPath();
      const y72 = pad + cH * (1 - 72 / 100);
      ctx.moveTo(pad, y72); ctx.lineTo(w - pad, y72);
      ctx.stroke(); ctx.setLineDash([]);
      ctx.strokeStyle = cs.getPropertyValue('--accent');
      ctx.lineWidth = 2; ctx.beginPath();
      last10.forEach((h, i) => { const x = pad + i * stepX, y = pad + cH * (1 - h.pct / 100); i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y); });
      ctx.stroke();
      ctx.fillStyle = cs.getPropertyValue('--accent');
      last10.forEach((h, i) => { const x = pad + i * stepX, y = pad + cH * (1 - h.pct / 100); ctx.beginPath(); ctx.arc(x, y, 4, 0, Math.PI * 2); ctx.fill(); });
    }

    // Mode Selection
    $("learningModeBtn").onclick = () => selectMode("learning");
    $("examModeBtn").onclick = () => selectMode("exam");

    function selectMode(m) {
      currentMode = m;
      $("learningModeBtn").classList.toggle("selected", m === "learning");
      $("examModeBtn").classList.toggle("selected", m === "exam");
      $("modeDesc").textContent = m === "learning" ? "üìö –í–∏–∂–¥–∞—à –≤–µ—Ä–Ω–∏—è –æ—Ç–≥–æ–≤–æ—Ä –≤–µ–¥–Ω–∞–≥–∞." : "üìù –†–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ —Å–µ –ø–æ–∫–∞–∑–≤–∞—Ç –Ω–∞–∫—Ä–∞—è.";
      $("step2num").classList.remove("active");
      $("step2num").classList.add("done");
      $("step3num").classList.add("active");
      loadOrGenerateExams();
    }

    // Exams
    function loadOrGenerateExams() {
      const saved = JSON.parse(localStorage.getItem('agentforce_exams') || 'null');
      if (saved && Array.isArray(saved) && saved.length === 5 && saved[0] && saved[0].length > 0) {
        EXAMS = saved;
      } else {
        const s = shuffle([...ALL_QIDS]);
        EXAMS = [];
        const size = Math.ceil(s.length / 5);
        for (let i = 0; i < 5; i++)EXAMS.push(s.slice(i * size, (i + 1) * size));
        saveExams();
      }
      renderExamButtons();
    }

    function renderExamButtons() {
      loadCompleted();
      const completed = getCompletedExams();
      $("examPlaceholder").style.display = "none";
      $("reshuffleBtn").classList.remove("hidden");
      selectedExamIndex = null;
      $("startBtn").disabled = true;
      $("examButtons").innerHTML = EXAMS.map((e, i) => {
        const done = completed.has(i);
        const style = done ? 'background:var(--success);color:#fff;border-color:var(--success);' : '';
        return `<button data-exam="${i}" style="${style}">–ò–∑–ø–∏—Ç ${i + 1} (${e.length})</button>`;
      }).join("");
    }

    $("reshuffleBtn").onclick = () => {
      const completed = getCompletedExams();
      if (completed.size > 0 && !confirm("–©–µ –Ω—É–ª–∏—Ä–∞—à –ø—Ä–æ–≥—Ä–µ—Å–∞ –Ω–∞ –∏–∑–ø–∏—Ç–∏—Ç–µ. –°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏?")) return;
      const s = shuffle([...ALL_QIDS]);
      EXAMS = [];
      completedLearning.clear();
      completedExam.clear();
      localStorage.setItem('agentforce_completed_learning', '[]');
      localStorage.setItem('agentforce_completed_exam', '[]');
      const size = Math.ceil(s.length / 5);
      for (let i = 0; i < 5; i++)EXAMS.push(s.slice(i * size, (i + 1) * size));
      saveExams();
      renderExamButtons();
      $("step3num").classList.remove("done");
      $("step3num").classList.add("active");
    };

    $("examButtons").onclick = e => {
      const btn = e.target.closest("button");
      if (!btn) return;
      $("examButtons").querySelectorAll("button").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      selectedExamIndex = Number(btn.dataset.exam);
      $("step3num").classList.remove("active");
      $("step3num").classList.add("done");
      $("startBtn").disabled = false;
    };

    $("startBtn").onclick = () => {
      if (selectedExamIndex === null || !currentMode) return;
      startRound("base", EXAMS[selectedExamIndex]);
    };

    $("exitBtn").onclick = () => {
      if (!confirm("–ü—Ä–æ–≥—Ä–µ—Å—ä—Ç —â–µ –±—ä–¥–µ –∑–∞–≥—É–±–µ–Ω.")) return;
      clearInterval(timerInterval);
      $("examUI").classList.add("hidden");
      $("setupPanel").classList.remove("hidden");
      renderExamButtons();
      $("step3num").classList.remove("done");
      $("step3num").classList.add("active");
    };

    // Timer
    function startTimer() {
      clearInterval(timerInterval);
      examStartTime = Date.now();
      if (currentMode === "learning") {
        $("timer").classList.add("hidden");
        return;
      }
      $("timer").classList.remove("hidden");
      $("timer").innerText = "Time: 105:00";
      timerInterval = setInterval(() => {
        const el = Math.floor((Date.now() - examStartTime) / 1000);
        const rem = Math.max(EXAM_TIME_SECONDS - el, 0);
        $("timer").innerText = `Time: ${String(Math.floor(rem / 60)).padStart(2, "0")}:${String(rem % 60).padStart(2, "0")}`;
        if (rem === 0) finishExam();
      }, 1000);
    }

    // Exam Flow
    function startRound(rt, stack) {
      if (!stack || !stack.length) return;
      currentRoundType = rt;
      STACK = stack.slice();
      index = 0;
      questionState = {};
      answerOrder = {};
      $("setupPanel").classList.add("hidden");
      $("statsPanel").classList.add("hidden");
      $("resultsPanel").classList.add("hidden");
      $("examUI").classList.remove("hidden");
      $("modeIndicator").textContent = currentMode === "learning" ? "üìö Learning" : "üìù Exam";
      $("modeIndicator").className = currentMode;
      $("progressFill").style.width = "0%";
      startTimer();
      questionStartTime = Date.now();
      showQuestion();
    }

    function showQuestion() {
      const qid = STACK[index], q = QUESTIONS[qid];
      ensureOrderForQid(qid);
      const state = questionState[qid];
      const answered = Object.values(questionState).filter(s => s.status && s.status !== "unanswered").length;
      $("progressFill").style.width = (answered / STACK.length * 100) + "%";
      $("counter").innerText = `[Q${qid}] ${index + 1}/${STACK.length}`;
      $("question").innerText = q.question;
      $("answers").innerHTML = "";
      $("resultLine").innerHTML = "";
      $("resultLine").style.background = "";
      $("resultLine").style.color = "";
      $("questionTime").textContent = state?.time ? `‚è±Ô∏è ${state.time}s` : "";
      $("dontKnow").checked = state?.dontKnow || false;
      $("notSure").checked = state?.notSure || false;
      answerOrder[qid].forEach(([l, t], i) => {
        $("answers").innerHTML += `<div class="answer" data-letter="${l}"><span>(${i + 1})</span><label><input type="radio" name="answer" value="${l}">${t}</label></div>`;
      });
      if (state?.selectedAnswer) {
        const r = document.querySelector(`input[name="answer"][value="${state.selectedAnswer}"]`);
        if (r) r.checked = true;
      }
      if (currentMode === "learning" && state && state.status && state.status !== "unanswered") {
        document.querySelectorAll('input[name="answer"]').forEach(r => r.disabled = true);
        $("dontKnow").disabled = true;
        $("notSure").disabled = true;
        const selWrap = document.querySelector(`input[name="answer"][value="${state.selectedAnswer}"]`)?.closest(".answer");
        if (state.status === "correct") {
          selWrap?.classList.add("correct");
          $("resultLine").innerText = "‚úÖ –í—è—Ä–Ω–æ";
          $("resultLine").style.background = "var(--success)";
          $("resultLine").style.color = "#fff";
        } else {
          selWrap?.classList.add("wrong");
          $("resultLine").innerText = `‚ùå –ì—Ä–µ—à–Ω–æ ‚Üí ${getCorrectText(qid)}`;
          $("resultLine").style.background = "var(--danger)";
          $("resultLine").style.color = "#fff";
        }
      } else {
        document.querySelectorAll('input[name="answer"]').forEach(r => r.disabled = false);
        $("dontKnow").disabled = false;
        $("notSure").disabled = false;
        if (!state || state.status === "unanswered") questionStartTime = Date.now();
      }
    }

    function upsertDraftState() {
      const qid = STACK[index], ex = questionState[qid];
      if (currentMode === "learning" && ex && ex.status && ex.status !== "unanswered") return;
      const sel = document.querySelector('input[name="answer"]:checked');
      questionState[qid] = {
        selectedAnswer: sel ? sel.value : (ex?.selectedAnswer || null),
        status: ex?.status || "unanswered",
        dontKnow: $("dontKnow").checked,
        notSure: $("notSure").checked,
        time: ex?.time || 0
      };
    }

    $("answers").onchange = e => { if (e.target?.name === "answer") upsertDraftState(); };
    $("answers").onclick = e => {
      const d = e.target.closest(".answer");
      if (d) {
        const r = d.querySelector('input[type="radio"]');
        if (r && !r.disabled) { r.checked = true; upsertDraftState(); }
      }
    };
    $("dontKnow").onchange = upsertDraftState;
    $("notSure").onchange = upsertDraftState;

    function checkCurrentQuestion() {
      const qid = STACK[index], q = QUESTIONS[qid];
      const sel = document.querySelector('input[name="answer"]:checked');
      if (!sel) return false;
      const t = Math.round((Date.now() - questionStartTime) / 1000);
      const ok = q.correct.includes(sel.value);
      questionState[qid] = {
        selectedAnswer: sel.value,
        status: ok ? "correct" : "wrong",
        dontKnow: $("dontKnow").checked,
        notSure: $("notSure").checked,
        time: t
      };
      if (!ok) { wrongCounts[qid] = (wrongCounts[qid] || 0) + 1; saveWrong(); }
      return true;
    }

    function nextAction() {
      const state = questionState[STACK[index]];
      const sel = document.querySelector('input[name="answer"]:checked');
      if (!sel) return;
      if (currentMode === "learning") {
        if (!state || state.status === "unanswered") { checkCurrentQuestion(); showQuestion(); return; }
        if (index < STACK.length - 1) { index++; questionStartTime = Date.now(); showQuestion(); }
        else finishExam();
      } else {
        checkCurrentQuestion();
        if (index < STACK.length - 1) { index++; questionStartTime = Date.now(); showQuestion(); }
        else finishExam();
      }
    }

    $("nextBtn").onclick = nextAction;
    $("backBtn").onclick = () => { if (index > 0) { index--; showQuestion(); } };

    document.onkeydown = e => {
      if ($("examUI").classList.contains("hidden")) return;
      if (["1", "2", "3", "4"].includes(e.key)) {
        const r = document.querySelectorAll('input[name="answer"]');
        if (r[e.key - 1] && !r[e.key - 1].disabled) { r[e.key - 1].checked = true; upsertDraftState(); }
      }
      if (e.key === "ArrowRight" || e.key === "Enter") nextAction();
      if (e.key === "ArrowLeft" && index > 0) { index--; showQuestion(); }
    };

    $("helpToggle").onclick = () => $("helpBox").classList.toggle("hidden");

    // Results
    function computeStats(st, arr) {
      let c = 0, w = [], dk = [], ns = [], cns = [], tt = 0;
      arr.forEach(qid => {
        const s = st[qid];
        if (!s || !s.status || s.status === "unanswered") return;
        if (s.dontKnow) dk.push(qid);
        if (s.notSure) ns.push(qid);
        tt += s.time || 0;
        if (s.status === "correct") { c++; if (s.notSure) cns.push(qid); }
        else w.push(qid);
      });
      return { correct: c, wrong: w, dk, ns, correctButNotSure: cns, totalTime: tt };
    }

    function finishExam() {
      clearInterval(timerInterval);
      $("examUI").classList.add("hidden");
      if (currentRoundType === "base") {
        baseState = deepClone(questionState);
        baseStack = STACK.slice();
        if (selectedExamIndex !== null) {
          getCompletedExams().add(selectedExamIndex);
          saveCompleted();
        }
        const st = computeStats(questionState, STACK);
        const t = STACK.length;
        const pct = t ? Math.round(st.correct / t * 100) : 0;
        const avgT = t ? Math.round(st.totalTime / t) : 0;
        history.push({ date: new Date().toISOString(), mode: currentMode, total: t, correct: st.correct, pct, avgTime: avgT });
        saveHistory();
      }
      renderResultsScreen();
    }

    function renderResultsScreen() {
      $("resultsPanel").classList.remove("hidden");
      const t = STACK.length;
      const { correct, wrong, dk, ns, correctButNotSure, totalTime } = computeStats(questionState, STACK);
      const pct = t ? Math.round(correct / t * 100) : 0;
      const passed = pct >= 72;
      const avgT = t ? Math.round(totalTime / t) : 0;
      const mLabel = currentMode === "learning" ? "üìö Learning" : "üìù Exam";
      const titles = { base: "–†–µ–∑—É–ª—Ç–∞—Ç", reviewWrong: "–ì—Ä–µ—à–Ω–∏", reviewNotSure: "–ù–µ—Å–∏–≥—É—Ä–Ω–∏", reviewDontKnow: "–ù–µ –∑–Ω–∞–º", reviewAll: "–í—Å–∏—á–∫–∏ –∑–∞ –ø—Ä–µ–≥–ª–µ–¥" };
      let reviewHtml = "";
      if (baseState && baseStack) {
        const bs = computeStats(baseState, baseStack);
        // Combine all questions for review (wrong + don't know + not sure, without duplicates)
        const allForReview = [...new Set([...bs.wrong, ...bs.dk, ...bs.ns])];
        reviewHtml = `<div id="reviewButtons">
      <button id="reviewAllBtn" ${allForReview.length ? "" : "disabled"}>üìã –í—Å–∏—á–∫–∏ –∑–∞ –ø—Ä–µ–≥–ª–µ–¥ (${allForReview.length})</button>
      <button id="reviewWrongBtn" ${bs.wrong.length ? "" : "disabled"}>üîÅ –ì—Ä–µ—à–Ω–∏ (${bs.wrong.length})</button>
      <button id="reviewNotSureBtn" ${bs.ns.length ? "" : "disabled"}>‚ö†Ô∏è –ù–µ—Å–∏–≥—É—Ä–Ω–∏ (${bs.ns.length})</button>
      <button id="reviewDontKnowBtn" ${bs.dk.length ? "" : "disabled"}>‚ùì –ù–µ –∑–Ω–∞–º (${bs.dk.length})</button>
      ${currentRoundType !== "base" ? `<button id="backToBaseResultsBtn">‚¨ÖÔ∏è –û—Å–Ω–æ–≤–µ–Ω</button>` : ""}
    </div>`;
      }
      $("resultsPanel").innerHTML = `
    <h3>${titles[currentRoundType]} <small style="font-weight:normal;color:var(--text2);">(${mLabel})</small></h3>
    <p style="font-size:20px;"><strong>${passed ? "‚úÖ –í–ó–ï–¢" : "‚ùå –ù–ï –ï –í–ó–ï–¢"}</strong> (–º–∏–Ω. 72%)</p>
    <p><strong>–í–µ—Ä–Ω–∏:</strong> ${correct}/${t} (${pct}%)</p>
    <p>‚ùå <strong>–ì—Ä–µ—à–Ω–∏:</strong> ${wrong.length ? wrong.join(", ") : "‚Äî"}</p>
    <p>‚ö†Ô∏è <strong>–í–µ—Ä–Ω–∏, –Ω–æ –Ω–µ—Å–∏–≥—É—Ä–Ω–∏:</strong> ${correctButNotSure.length ? correctButNotSure.join(", ") : "‚Äî"}</p>
    <p>‚ùì <strong>–ù–µ –∑–Ω–∞–º:</strong> ${dk.length ? dk.join(", ") : "‚Äî"}</p>
    <p>‚è±Ô∏è <strong>–í—Ä–µ–º–µ:</strong> ${Math.floor(totalTime / 60)}m ${totalTime % 60}s (${avgT}s/–≤—ä–ø—Ä.)</p>
    ${reviewHtml}
    <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap;">
      <button id="newExamBtn" style="flex:1;">üîÑ –ù–æ–≤ –∏–∑–ø–∏—Ç</button>
      <button id="viewStatsBtn" style="flex:1;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</button>
    </div>`;
      $("newExamBtn").onclick = resetToSetup;
      $("viewStatsBtn").onclick = () => { renderStatsPanel(); $("statsPanel").classList.remove('hidden'); };
      // Review buttons work for both modes
      $("reviewAllBtn")?.addEventListener("click", () => {
        const bs = computeStats(baseState, baseStack);
        const allForReview = [...new Set([...bs.wrong, ...bs.dk, ...bs.ns])];
        $("resultsPanel").classList.add("hidden");
        startRound("reviewAll", allForReview);
      });
      $("reviewWrongBtn")?.addEventListener("click", () => { $("resultsPanel").classList.add("hidden"); startRound("reviewWrong", computeStats(baseState, baseStack).wrong); });
      $("reviewNotSureBtn")?.addEventListener("click", () => { $("resultsPanel").classList.add("hidden"); startRound("reviewNotSure", computeStats(baseState, baseStack).ns); });
      $("reviewDontKnowBtn")?.addEventListener("click", () => { $("resultsPanel").classList.add("hidden"); startRound("reviewDontKnow", computeStats(baseState, baseStack).dk); });
      $("backToBaseResultsBtn")?.addEventListener("click", () => { currentRoundType = "base"; questionState = deepClone(baseState); STACK = baseStack.slice(); renderResultsScreen(); });
    }

    function resetToSetup() {
      $("resultsPanel").classList.add("hidden");
      $("setupPanel").classList.remove("hidden");
      if (EXAMS.length > 0 && currentMode) {
        renderExamButtons();
        $("step3num").classList.remove("done");
        $("step3num").classList.add("active");
      } else {
        currentMode = null;
        $("learningModeBtn").classList.remove("selected");
        $("examModeBtn").classList.remove("selected");
        $("step2num").classList.remove("done");
        $("step2num").classList.add("active");
        $("step3num").classList.remove("done", "active");
        $("examButtons").innerHTML = "";
        $("examPlaceholder").style.display = "";
        $("reshuffleBtn").classList.add("hidden");
        $("startBtn").disabled = true;
        $("modeDesc").textContent = "–ò–∑–±–µ—Ä–∏ –∫–∞–∫ –∏—Å–∫–∞—à –¥–∞ —Å–µ —É–ø—Ä–∞–∂–Ω—è–≤–∞—à.";
      }
    }
  </script>
</body>

</html>